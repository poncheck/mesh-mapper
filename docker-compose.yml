services:
  db:
    image: timescale/timescaledb:latest-pg16
    container_name: mesh-mapper-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=meshuser
      - POSTGRES_PASSWORD=meshpass
      - POSTGRES_DB=meshmapper
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mqtt-worker:
    build: ./mqtt_worker
    container_name: mqtt-worker
    restart: unless-stopped
    environment:
      - MQTT_HOST=192.168.88.30
      - MQTT_PORT=1883
      - MQTT_TOPIC=msh/#
      - LOG_PATH=/logs/mqtt_raw.log
      - DATABASE_URL=postgresql://meshuser:meshpass@db:5432/meshmapper
    volumes:
      - ./logs:/logs
    depends_on:
      - db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    build: ./api
    container_name: mesh-mapper-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=meshmapper
      - POSTGRES_USER=meshuser
      - POSTGRES_PASSWORD=meshpass
    depends_on:
      - db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  db_data:
